# ü§ñ LLM Context Guide for RoboMage

This guide helps AI assistants quickly understand the RoboMage project structure and context.

**Essential Files to Read First (November 2025 - Post Sprint 3+4 Merge)**

**Core Architecture & API:**
1. `README.md` - Project overview, comprehensive API documentation, and usage examples
2. `src/robomage/__init__.py` - Main package API and public interface  
3. `src/robomage/data/models.py` - Core data structures (DiffractionData, DataStatistics)
4. `src/robomage/data/loaders.py` - Enhanced file loading (.chi, .xy formats)
5. `.github/copilot-instructions.md` - **CRITICAL**: Comprehensive architecture guide

**Microservices & Dashboard:**
6. `services/peak_analysis/main.py` - FastAPI microservice for peak analysis
7. `src/robomage/clients/peak_analysis_client.py` - HTTP client library
8. `src/robomage/dashboard/app.py` - Dash-based visualization dashboard  
9. `peak_analyzer.py` - Standalone CLI tool with multiple operation modes
10. `pixi.toml` - Environment configuration and available tasks

**Documentation & Examples:**
11. `docs/sprint-4-visualization-dashboard.md` - Current development status
12. `examples/load_data_example.py` - Comprehensive tutorial (both APIs)
13. `examples/xy_file_example.py` - XY file format examples
14. `tests/test_peak_analysis_integration.py` - Service integration tests

## üèóÔ∏è Project Architecture Summary

**Language & Environment:** Python 3.10+ with Pixi environment management  
**Core Framework:** Pydantic v2 for data validation, NumPy/Pandas for scientific computing  
**Code Quality:** Ruff (formatting/linting), MyPy (type checking), Pytest (testing)  
**Architecture:** **Microservices-based** with independent FastAPI services  

**Dual API Design:**
- **Modern API**: `robomage.load_diffraction_file()` ‚Üí `DiffractionData` (Pydantic models)
- **Legacy API**: `robomage.data_io.load_test_data()` ‚Üí `pandas.DataFrame`
  - Also available as: `robomage.load_test_data_df()`, `robomage.load_chi_file_df()`, `robomage.get_data_info()`

**Microservices Components:**
- **Core Framework**: Data loading, validation, and client libraries (`src/robomage/`)
- **Peak Analysis Service**: Independent FastAPI microservice (`services/peak_analysis/`)  
- **Dashboard Framework**: Professional 3-tab Dash UI (`src/robomage/dashboard/`)
- **Client Libraries**: HTTP integration for service communication (`src/robomage/clients/`)
- **CLI Tools**: Multiple operation modes - direct, service, client (`peak_analyzer.py`)

**Enhanced Features:**
- **File Support**: .chi and .xy formats with auto-detection
- **Type Safety**: pandas-stubs integration, 50% fewer MyPy errors
- **Professional UI**: Tab-based dashboard with wavelength management
- **Service Architecture**: REST API with retry logic and validation

## üéØ Current Status (November 2025 - Sprint 3 + Sprint 4 Phase 1.5 COMPLETE)

**‚úÖ Production-Ready Features:**
‚úÖ **Microservices Architecture** - Complete FastAPI peak analysis service  
‚úÖ **Professional Dashboard** - 3-tab Dash UI with wavelength management  
‚úÖ **Enhanced Data Loading** - .chi and .xy file support with validation  
‚úÖ **Type Safety Improvements** - pandas-stubs, 50% fewer MyPy errors  
‚úÖ **Peak Analysis Engine** - Multi-profile fitting (Gaussian, Lorentzian, Voigt)  
‚úÖ **HTTP Client Libraries** - Retry logic and service integration  
‚úÖ **Comprehensive Testing** - 37/37 tests passing (integration + unit)  
‚úÖ **Code Quality** - All linting clean, formatted, type-checked  

**üîÑ Current Sprint - Dashboard Phase 2 (Ready to Start):**
üîÑ **Analysis Tab Integration** - Connect peak analysis service to dashboard  
üîÑ **Real-time Peak Detection** - Interactive parameter tuning in UI  
üîÑ **Enhanced Visualization** - Peak annotations and fitted curves  
üîÑ **Results Export** - Multiple format support (JSON, CSV, plots)  

**üöÄ Future Development (Planned):**
ÔøΩ GSAS-II integration for automated Rietveld refinement  
ÔøΩ Advanced data pipeline with Tiled/Databroker integration  
ÔøΩ Machine learning-guided parameter optimization  
üöÄ Multi-user collaborative analysis features  

## üõ†Ô∏è Development Patterns

**Code Style:**
- Use Pydantic models for new data structures
- Include comprehensive docstrings with examples
- Maintain both modern and legacy API compatibility
- Follow scientific Python conventions (Q for momentum transfer, etc.)

**Testing:**
- Test files match pattern `test_*.py` in `tests/` directory
- Use pytest with parametrization for multiple test cases
- Include both unit tests and integration examples
- Current test coverage: 20 tests across 4 files:
  - `test_data_models.py` (8 tests) - Core data structure functionality
  - `test_data_loaders.py` (6 tests) - File loading and validation
  - `test_data_io.py` (5 tests) - Legacy API compatibility
  - `test_schema.py` (1 test) - Configuration schema validation

**Common Tasks:**
```bash
# Core Development  
pixi run test      # Run full test suite (37 tests - pytest -q)
pixi run lint      # Check code style (ruff check .)
pixi run format    # Auto-format code (ruff format .)
pixi run typecheck # Type checking (mypy src - core files only)
pixi run check     # Run all checks (format-check, lint, typecheck, test)

# Dashboard Development
pixi run dashboard          # Start dashboard (port 8050)
pixi run dashboard-debug    # Dashboard with debug mode

# Microservices
cd services/peak_analysis && python main.py --port 8001  # Start peak analysis service
python peak_analyzer.py --help                          # CLI tool help
python peak_analyzer.py sample.chi                      # Direct analysis
python peak_analyzer.py --service --port 8001           # Service mode
```

## üìä Key Data Structures

**DiffractionData** (Modern API):
```python
data = robomage.load_diffraction_file("sample.chi")
data.q_values          # NumPy array of Q values (√Ö‚Åª¬π)
data.intensity_values  # NumPy array of intensities
data.statistics        # DataStatistics with computed properties
data.trim_q_range(2,8) # Filter by Q range
data.to_dataframe()    # Convert to pandas DataFrame
```

**DataStatistics** (Computed Properties):
```python
stats = data.statistics
stats.q_range          # (min, max) Q values (tuple)
stats.num_points       # Number of data points
stats.intensity_mean   # Mean intensity
stats.intensity_std    # Standard deviation of intensities
stats.q_step_mean      # Average Q step size
stats.q_step_std       # Standard deviation of Q step size
stats.intensity_range  # (min, max) intensity values (tuple)
```

## üö® Important Context Notes

1. **File Formats**: Supports .chi and .xy files (two-column: Q, intensity) with auto-detection
2. **Test Data**: Built-in SRM 660b LaB‚ÇÜ standard available via `load_test_data()`
3. **Validation**: Automatic Q-value sorting and NaN/inf detection
4. **Error Handling**: Comprehensive with clear scientific error messages
5. **Microservices**: FastAPI peak analysis service runs independently on port 8001
6. **Dashboard**: Professional 3-tab Dash UI on port 8050 with wavelength management
7. **Version**: Currently 0.0.1 (development), production-ready microservices architecture
8. **Type Safety**: MyPy configured for core library files only (dashboard excluded for complex Dash types)

**Current Module Structure:**
   - `src/robomage/data/` - Enhanced data handling (models, loaders) with .xy support
   - `src/robomage/clients/` - **NEW**: HTTP clients for service integration
   - `src/robomage/dashboard/` - **NEW**: Professional Dash-based UI framework
   - `services/peak_analysis/` - **NEW**: Independent FastAPI microservice
   - `src/robomage/config/` - Configuration schemas with refinement planning
   - `src/robomage/data_io.py` - Legacy pandas-based API (maintained)
   - `src/robomage/__main__.py` - Enhanced CLI with dashboard integration
   - `src/robomage/visualization.py` - Publication-quality plotting utilities
   - `peak_analyzer.py` - **NEW**: Standalone CLI tool with multiple operation modes

## üîç Debugging Tips

- **Tests**: `pixi run test` should show 37/37 tests passing (includes integration tests)
- **Examples**: Use `examples/load_data_example.py` and `examples/xy_file_example.py` 
- **Service Health**: `curl http://localhost:8001/health` to check peak analysis service
- **Dashboard**: `pixi run dashboard` launches on http://localhost:8050
- **CLI Help**: `python peak_analyzer.py --help` for standalone tool options
- **Data Validation**: Most errors caught by Pydantic models with clear messages
- **Legacy API**: Check `src/robomage/data_io.py` for pandas-based workflows
- **Integration**: See `tests/test_peak_analysis_integration.py` for service communication patterns
- **Type Issues**: MyPy only checks core library (dashboard complexity excluded)
- **Service Logs**: FastAPI service provides detailed request/response logging

## üìù Documentation Standards

- Include scientific context (powder diffraction, momentum transfer Q)
- Provide working code examples in docstrings
- Explain both modern and legacy usage patterns
- Reference test data (SRM 660b) in examples
- Use proper units (√Ö‚Åª¬π for Q, arbitrary units for intensity)

---

**Last Updated:** November 12, 2025  
**Project Status:** Sprint 3 + Sprint 4 Phase 1.5 COMPLETE - Production-ready microservices architecture  
**Next Phase:** Dashboard Phase 2 - Service integration in analysis tab (estimated 2-3 days)  
**Architecture:** Mature microservices framework ready for advanced scientific workflows